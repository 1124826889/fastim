## FastIM
> 基于Netty的高扩展高可用分布式即时通讯系统，支持单聊、群聊、登录登出、聊天记录查询、离线消息存储、消息推送、心跳、分布式唯一ID等功能。支持分布式部署并且基于MQ的可扩展性架构。

## 分布式IM难点
1. 消息有序性和可靠性
2. 读扩散和写扩散实现
3. 群聊的实现

## 一、系统设计
### 1. 逻辑图和架构图
#### gate设计：
1. 任何一个gate网关断掉，用户端检测到以后重连另一个gate网关就可以了，对整体服务可靠性基本没有影响。
2. 客户端通过LSB，来获取gate IP地址，通过IP直连，目的是
    - 灵活的负载均衡策略 可根据最少连接数来分配IP
    - 做灰度策略来分配IP
    - AppId业务隔离策略 不同业务连接不同的gate，防止相互影响
    

#### router设计：
1、把用户状态信息存储在Redis集群里。因此也是无状态的，任何一个router服务挂掉，不影响整体服务能力。


#### storage设计：
抽一层处理，目的是
- 定时将冷数据迁移到Cold存储系统
- 多个存储系统的实现

### 2. 协议设计
### 3. Session管理
### 4. 安全管理
### 5. 消息管理
### 6. 高并发支持
水平扩展：各个模块无状态部署
线程模型：netty主从reactor模型

### 7. 网关设计

### 8. 业务优化
系统稳定性在客户端层面，发现服务断开之后要有一个策略，防止大量用户同一时间去链接某个服务器导致雪崩效应。
解决方法：LBS：跟服务器申请重连的新的服务器IP，也就是gate地址，然后由LBS服务去降低短时间分配到同一个服务器的用户量。

群组优化
1. 批量消息处理
2. redis扩散写，MySQL扩散读
3. 群消息和成员批量加载


### 9. 心跳设计
1. 服务端检测到某个客户端迟迟没有心跳过来可以主动关闭通道，让它下线；
2. 客户端检测到某个服务端迟迟没有响应心跳也能重连获取一个新的连接。


## 二、技术选型
1. 配置中心 Etcd
2. 注册中心 
2. 服务端语言和框架 Java + Spring + Netty
3. 打包框架 Gradle
4. 消息队列 RocketMQ

## 三、Function
### TODO
1. 网关设计
2. 聊天记录存储和查询
3. 客户端自动重连
4. 离线消息
5. 群聊c2g
6. 登录、注册、登出实现
7. 唯一设备踢出
8. 路由服务服务实现
9. 消息推送、数据上报
10. 文件发送，图片发送
11. 消息安全：聊天加密
12. 提供客户端jar
13. 群红包
14. 多端同步消息

### Finish
1. IM架构设计
2. 单聊c2c
3. 通信协议设计 protobuf作为序列化框架
4. 分布式ID设计
    - 会话 ID
    - 消息 ID
5. 心跳保活设计

## 四、IM架构需要考虑的地方
#### 消息可靠性如何保证 不丢消息
#### 消息顺序性如何保证 不乱序
#### 消息重复性如何保证 不重复
1. 如何支持多个设备在线，并且如何保证消息一致性
2. 如何处理消息发送失败
3. 如果采用可靠传输协议TCP，需要考虑到负载问题：短连接实现账号、关系链相关业务，长连接实现上线、信息推送
4. 后台架构的灵活性、可扩展性：支持分布式部署——把网络层、业务逻辑层、数据层分离，网络层和业务层支持负载均衡策略、数据层支持分布式存储；
5. 客户端SDK的易用性：把网络层、数据层分离、业务逻辑层分离。
10. 编码角度：采用高效的网络模型，线程模型，I/O处理模型，合理的数据库设计和操作语句的优化；
11. 垂直扩展：通过提高单服务器的硬件资源或者网络资源来提高性能；
12. 水平扩展：通过合理的架构设计和运维方面的负载均衡策略将负载分担，有效提高性能；后期甚至可以考虑加入数据缓存层，突破IO瓶颈；
13. 系统的高可用性：防止单点故障；
14. 在架构设计时做到业务处理和数据的分离，从而依赖分布式的部署使得在单点故障时能保证系统可用。
15. 对于关键独立节点可以采用双机热备技术进行切换。

大型架构需要考虑的：灰度；监控；告警；缓存；限流；低耦合，高内聚；避免单点，拥抱无状态；评估；压测

## 五、性能测试

## 六、Q&A




## 七、参考

IM架构参考图
https://gitee.com/drunk_and_happy/oss/raw/master/mypic/IM%E6%9E%B6%E6%9E%841.png
https://gitee.com/drunk_and_happy/oss/raw/master/mypic/IM%E6%9E%B6%E6%9E%842.jpg

IM架构文章
http://www.52im.net/thread-812-1-1.html  IM架构设计实践
http://www.52im.net/forum.php?mod=viewthread&tid=3472&ctid=7 分布式IM系统设计
http://www.52im.net/thread-300-1-1.html 58到家消息系统的架构设计
https://mp.weixin.qq.com/s/TUIxcg0EJC0S26gKrKqYKg 瓜子IM系统设计
https://mp.weixin.qq.com/s/TYUNPgf_3rkBr38rNlEZ2g 分布式IM系统设计
https://mp.weixin.qq.com/s/a4sDH48PWTHax2uBej1Jtg 基于消息总线的高可扩展性IM系统后台架构设计
https://help.aliyun.com/document_detail/141820.html 阿里云IM消息系统设计



IM消息同步实现
http://www.52im.net/thread-1230-1-1.html  消息的同步和存储方案
http://www.52im.net/thread-714-1-1.html  保证IM实时消息的“时序性”与“一致性”

协议
http://www.52im.net/thread-298-1-1.html 58到家实时消息系统的协议设计


网关
https://www.jianshu.com/p/1346f7fb6442 网关基于Netty在Http协议的实践
https://mp.weixin.qq.com/s/XS1_dSDqebUL85gtJn-DeA 喜马拉雅网关实践
http://www.linkedkeeper.com/detail/blog.action?bid=1065  京麦网关实践
https://mp.weixin.qq.com/s/67qc-xN-LtVvAtYTS0Fr8A 知乎长连接网关